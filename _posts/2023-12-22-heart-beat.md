---
layout: post
title: 为什么基于TCP的应用需要心跳包
categories: [net]
tags: [性能优化]
---

# Q: 关于TCP保活机制的配置,一共是是这四个配置
```text
是否开启保活。
空闲多久后开始保活探测
多久发送一个词保活探测。
最大探测多少次后可以判断连接空闲，可以关闭。
```
A:
```text
是的，你总结得非常准确。以下是关于TCP保活的几个配置参数及其作用：

1. 是否开启保活：可以通过设置TCP的keepalive选项来启用或禁用TCP保活机制。当启用TCP保活时，操作系统会在连接空闲时发送保活探测来检测连接的有效性。

2. 空闲多久后开始保活探测：通过TCP_KEEPIDLE参数来设置，表示连接在空闲多少秒后开始发送保活探测。如果在这段时间内没有数据传输或接收，操作系统会发送保活探测来检测连接的有效性。

3. 多久发送一个保活探测：通过TCP_KEEPINTVL参数来设置，表示两次保活探测之间的间隔时间。如果在空闲时间超过TCP_KEEPIDLE设置的阈值后，每隔TCP_KEEPINTVL秒，操作系统会发送一次保活探测。

4. 最大探测多少次后可以判断连接空闲，可以关闭：通过TCP_KEEPCNT参数来设置，表示在没有从对端获得响应的情况下，发送保活探测的最大次数。如果在达到最大次数后仍然没有获得对端的响应，操作系统将判定连接为空闲，可以关闭这个连接。

通过调整这些参数，可以根据实际需求来定制TCP保活机制的行为，以提高连接的可靠性和资源利用效率。****
```

# 参考

1.[为什么基于TCP的应用需要心跳包（TCP keep-alive原理分析）](https://hengyun.tech/why-we-need-heartbeat/)

抓包可以看到两类情况

* 正常探活: 每20秒发送探测包(keep-alive包,tcp_keepalive_time配置为20时)

* 网络连接出问题了: 20秒发送探测包没有收到回复后，判断连接出问题了，继续探测8次，也就是每隔一秒重发了9次tcp keep-alive，9次都没有响应，则发送rst包关闭连接。