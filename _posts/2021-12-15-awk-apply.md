---
layout: post
title: awk的应用场景
categories: [性能优化]
tags: [性能优化]
---

# 背景
偶然看到一篇性能优化博客,里面记录了awk统计了小时内每分钟的平均调用时长。

```cmd
cat 性能日志 | grep '时间点 | awk -F ' ' '{print $2, $5}' |.......| awk -F ' ' '{sum[$1]+=$3;count[$1]+=1}END{for(i in sum) {print i,sum[i]/count[i]}}'   
```


# awk 打印出最后一行的第1列或者第2列？
打印最后一行的第二列就这样：
awk 'END{print $2}' yourfile
打印指定行的指定列（例如第4行第2列）：
awk 'NR==4{print $2}' yourfile


# 从后往前
有时awk的print$是按照空格区分的,如果日志里有有个字段内容包含空格,则分割会错误。
有时发现可以从后往前分割就可以了。
// 附录6


# grep|sed|awk 正则截取字符串
// 附录7,8
```bash
grep: 
echo ...|grep -oP 'word.*abcd'

sed:
echo ... |sed -r 's/.*(word.*abcd).*/\1/g'

awk:
echo ... |awk '{print gensub(".*(word.*abcd).*","\\1","g")}' 
```

## 实例
```bash
参数oP一起使用，会单独打印出要匹配的数字
[root@ss-server ~]# echo office365 | grep -oP "\d+"
365
[root@ss-server ~]# echo office365 | grep -oP "\d*"
365
[root@ss-server ~]# echo office365 | grep -oP "[0-9]*"
365
[root@ss-server ~]# echo 365beijing23 | grep -oP "\d+"
365
23
[root@ss-server ~]# echo 365beijing23 | grep -oP "\d*"
365
23
[root@ss-server ~]# echo 365beijing23 | grep -oP "[0-9]*"
365
23
```

实例: 
```bash
  371  cat gin-http.log.2022-02-10 |grep 'eqq-notify'|grep -w 'old_user_tag=gdt-yfioslk'|grep -w 'app_type=ios'|grep -oP 'muid.*?&'> old_user_idfa.txt
```

匹配什么开头的字符串 
```bash
echo "abcabc12312" |grep -oP "(?<=(abc)).*"
```


## awk + uniq
```shell
awk -F ' ' '{print $2, $5}' | uniq -c

awk -F ',' '{print $1}' | uniq -c
```


# TODO
```sh
# awk for循环统计 行数n,累加t+,平均值t/n  => 行数,耗时毫秒,平均耗时数
grep part3 main.log | grep '耗时' | awk -F ',' '{print $5}' | awk -F'"' '{print $4}' | awk -F"." '{n+=1; t+=$1} END{print n, t, t/n}'
```

# 参考
1.[解Bug之路-记一次线上请求偶尔变慢的排查--awk统计了下 B系统这个小时内每分钟的平均调用时长](https://my.oschina.net/alchemystar/blog/4651051)
2.[使用awk命令获取文本的某一行，某一列](https://blog.csdn.net/aywb1314/article/details/52239281)
3.[linux之awk命令获取最后一列](https://blog.csdn.net/slx_2011/article/details/19827307)
4.[linux-awk中NF与$NF的区别](https://blog.csdn.net/github_33736971/article/details/54286736)
5.[awk 打印出最后一行的第1列或者第2列？](https://zhidao.baidu.com/question/625631586977326644.html)
6.[AWK 技巧（取倒列，过滤行，匹配，不匹配，内置变量等）](https://www.cnblogs.com/kevingrace/p/8481965.html)
7.[grep|sed|awk 正则截取字符串](https://segmentfault.com/q/1010000003751141###)
8.[grep 正则截取字符串实例](https://www.cnblogs.com/kevingrace/p/9299232.html)